<html>
<head>
	<title>Hey, listen!</title>

	<script type="text/javascript">
		var heyListenCount = 0;
		var isHeyListening = false;

		function calcTreasureCloseness() {
			var player = document.getElementById("player");
			var chest1 = document.getElementById("chest1");
			var treasureCloseness = Math.abs(parseInt(player.style.left) - parseInt(chest1.style.left));
			return treasureCloseness / window.innerWidth;
		}

		function resetHeyListen() {
			var treasureCloseness = calcTreasureCloseness();

			heyListenCount = Math.round(35 * treasureCloseness) + 1;

			heyListenTimeout = 300 / treasureCloseness;
			isHeyListening = true;
			setTimeout(function() { isHeyListening = false; }, heyListenTimeout);
		}

		function heyListen() {
			heyListenCount--;
			if(heyListenCount < 0) {
				resetHeyListen();

				new Audio("hey_listen.mp3").play();				

				var treasureCloseness = calcTreasureCloseness();
				var naviCount = (Math.round(Math.random() * 3) / treasureCloseness) + 2;
				for(var i = 0; i < naviCount; i++) {
					showNavi();
				}
			}
		}

		function showNavi() {
			var navi = document.createElement("img");
			navi.src = "navi.jpeg";
			navi.style.position = "absolute";
			navi.style.top = Math.round(Math.random() * window.innerHeight) + 'px';
			navi.style.left = Math.round(Math.random() * window.innerWidth) + 'px';
			navi.style.width = Math.round(Math.random() * 200) + 'px';
			navi.style.height = navi.style.width;
			document.body.appendChild(navi);
		}

		function leftArrowPressed() {
			var element = document.getElementById("player");
			var newLeft = parseInt(element.style.left) - 5;
			if(newLeft > 0) {
		    		element.style.left = newLeft + 'px';
			}
			var didHeyListen = heyListen();
		}

		function rightArrowPressed() {
			var element = document.getElementById("player");
			var newLeft = parseInt(element.style.left) + 5;
			if(newLeft + parseInt(element.style.width) < window.innerWidth) {
				element.style.left = newLeft + 'px';
			}
			heyListen();
		}

		function upArrowPressed() {
			var element = document.getElementById("player");
			var newTop = parseInt(element.style.top) - 5;
			if(newTop > 0) {
				element.style.top = newTop + 'px';
			}
			heyListen();
		}

		function downArrowPressed() {
			var element = document.getElementById("player");
			var newTop = parseInt(element.style.top) + 5;
			if(newTop + parseInt(element.style.height) < window.innerHeight) {
				element.style.top = newTop + 'px';
			}
			heyListen();
		}

		function moveSelection(evt) {
			if(isHeyListening) {
				return;
			}

			switch (evt.keyCode) {
				case 37:
					leftArrowPressed();
					break;
				case 39:
					rightArrowPressed();
					break;
				case 38:
					upArrowPressed();
					break;
				case 40:
					downArrowPressed();
					break;
			}
		}

		function docReady() {
			document.body.style.overflow = 'hidden';

			window.addEventListener('keydown', moveSelection);
			var element = document.getElementById("player");
			element.style.top = (window.innerHeight / 2) + 'px';
			element.style.left = (window.innerWidth - parseInt(element.style.width) - 10) + 'px';

			resetHeyListen();
			isHeyListening = false;
			setChestPosition();

			window.onresize = function() {
				setChestPosition();
			};
		}

		function setChestPosition() {
			var chest = document.getElementById("chest1");
			chest.style.top = (window.innerHeight / 2) + 'px';
		}
	</script>
</head>

<body onload="docReady()" onkeydown="" onkeyup="">
	<h1 align="center" style="font-family: helvetica; margin-top: 20px;">Get the treasure!</h1>
	<img id="player" src="link.gif" style="position: absolute; top: 0; left: 0; width: 70px; height: 70px;">
	<img id="chest1" src="chest.png" style="position: absolute; top: 0; left: 10px; width: 70px; height: 70px;">
</body>

</html>
